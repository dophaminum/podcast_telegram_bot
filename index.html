<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color, #222); color: var(--tg-theme-text-color, #fff); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; height: 100vh; box-sizing: border-box; }
        #title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        audio { width: 100%; max-width: 400px; }
        /* --- НОВЫЙ СТИЛЬ ДЛЯ ОТОБРАЖЕНИЯ ВРЕМЕНИ --- */
        #time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #aaa);
            margin-top: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    <!-- --- НОВЫЙ ЭЛЕМЕНТ ДЛЯ ВРЕМЕНИ --- -->
    <div id="time-display">--:-- / --:--</div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        // --- ПОЛУЧАЕМ НОВЫЙ ЭЛЕМЕНТ ---
        const timeDisplay = document.getElementById('time-display');
        
        let fileId = null;
        let storageKey = null;

        // --- НОВАЯ ФУНКЦИЯ ДЛЯ ФОРМАТИРОВАНИЯ ВРЕМЕНИ ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) {
                return "--:--";
            }
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        try {
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const startTimeFromParam = parseInt(urlParams.get('start_time') || '0', 10);
            // Получаем общую длительность из параметров
            const totalDuration = parseInt(urlParams.get('duration') || '0', 10);

            if (!fileUrl || !fileId) {
                throw new Error("ID файла или URL не указаны.");
            }
            
            storageKey = `progress_${fileId}`; 
            const savedProgress = localStorage.getItem(storageKey);
            let lastPosition = savedProgress ? parseInt(savedProgress, 10) : 0;
            
            titleDiv.innerText = fileName;
            player.src = fileUrl;
            // Сразу отображаем общую длительность
            timeDisplay.innerText = `${formatTime(lastPosition)} / ${formatTime(totalDuration)}`;

            player.addEventListener('canplaythrough', () => {
                player.currentTime = startTimeFromParam > 0 ? startTimeFromParam : lastPosition;
                player.play();
            }, { once: true });

            player.addEventListener('timeupdate', () => {
                const currentTime = Math.floor(player.currentTime);
                // Обновляем отображение времени
                timeDisplay.innerText = `${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
                // Сохраняем прогресс в localStorage
                localStorage.setItem(storageKey, currentTime);
            });

            player.addEventListener('ended', () => {
                localStorage.setItem(storageKey, '0');
            });

        } catch (e) {
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>

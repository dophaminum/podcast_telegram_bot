<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color, #222); color: var(--tg-theme-text-color, #fff); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; height: 100vh; box-sizing: border-box; }
        #title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        audio { width: 100%; max-width: 400px; }
        #time-display { font-family: 'Courier New', Courier, monospace; font-size: 16px; color: var(--tg-theme-hint-color, #aaa); margin-top: 8px; margin-bottom: 20px; }
        /* --- СТИЛЬ ДЛЯ НОВОЙ КНОПКИ --- */
        #save-button {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    <div id="time-display">--:-- / --:--</div>
    
    <!-- --- НОВАЯ КНОПКА СОХРАНЕНИЯ --- -->
    <button id="save-button">Сохранить прогресс и закрыть</button>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- Получаем HTML-элементы ---
        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        const timeDisplay = document.getElementById('time-display');
        
        // --- Переменные для хранения состояния ---
        let fileId = null;
        let userId = null; // ID пользователя для отправки на сервер
        let storageKey = null; // Ключ для localStorage
        let lastUpdateTime = 0; // Для ограничения частоты запросов
        let baseApiUrl = '';

        // --- НОВАЯ ФУНКЦИЯ: Отправка прогресса на наш сервер через Fetch ---
        async function sendProgressUpdate(isFinished = false) {
            if (!fileId || !userId) return;

            const currentTime = Math.floor(player.currentTime);
            const data = {
                file_id: parseInt(fileId, 10),
                user_id: parseInt(userId, 10),
                position: currentTime,
                is_finished: isFinished
            };

            try {
                // --- ГЛАВНОЕ ИСПРАВЛЕНИЕ ЗДЕСЬ ---
                // Мы отправляем запрос на ПОЛНЫЙ АДРЕС НАШЕГО СЕРВЕРА.
                const response = await fetch(`${baseApiUrl}/api/update_progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                // ------------------------------------

                const responseData = await response.json();
                console.log('Progress update response:', responseData);

            } catch (error) {
                console.error('Failed to send progress update:', error);
            }
        }
        // Вспомогательная функция для форматирования времени
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) {
                return "--:--";
            }
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        try {
            // --- Основной блок ---
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            userId = urlParams.get('user_id'); // Получаем user_id
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const totalDuration = parseInt(urlParams.get('duration') || '0', 10);
            
            if (!fileUrl || !fileId || !userId) {
                throw new Error("Ключевые параметры (file_id, user_id, file_url) не указаны.");
            }
            
            // --- Логика localStorage (остается главной) ---
            storageKey = `progress_${fileId}`; 
            const savedProgress = localStorage.getItem(storageKey);
            let lastPosition = savedProgress ? parseInt(savedProgress, 10) : 0;
            
            titleDiv.innerText = fileName;
            player.src = fileUrl;
            timeDisplay.innerText = `${formatTime(lastPosition)} / ${formatTime(totalDuration)}`;

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ПЛЕЕРА ---
            player.addEventListener('canplaythrough', () => {
                // Всегда доверяем localStorage при старте
                player.currentTime = lastPosition;
                player.play();
            }, { once: true });

            player.addEventListener('timeupdate', () => {
                const currentTime = Math.floor(player.currentTime);
                // 1. Обновляем время на экране
                timeDisplay.innerText = `${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
                // 2. Надежно сохраняем в localStorage
                localStorage.setItem(storageKey, currentTime);
                // 3. Пытаемся отправить данные на сервер (не чаще раза в 5 сек)
                const now = Date.now();
                if (now - lastUpdateTime > 5000) {
                    sendProgressUpdate();
                    lastUpdateTime = now;
                }
            });

            player.addEventListener('ended', () => {
                localStorage.setItem(storageKey, '0');
                sendProgressUpdate(true);
            });

            player.addEventListener('error', () => {
                const errorMessage = 'Ошибка загрузки аудио. Убедитесь, что сервер запущен.';
                tg.showAlert(errorMessage);
            });

        } catch (e) {
            // Показываем пользователю критические ошибки
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
 
    </script>
</body>
</html>







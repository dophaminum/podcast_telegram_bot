<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #222);
            color: var(--tg-theme-text-color, #fff);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }
        #title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        audio {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        #status {
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
        /* ---- НОВЫЕ СТИЛИ ДЛЯ КНОПОК ТАЙМКОДОВ ---- */
        #timecodes-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Расстояние между кнопками */
            overflow-y: auto; /* Позволяет прокручивать, если кнопок много */
        }
        .timecode-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color, #333);
            color: var(--tg-theme-text-color, #fff);
            cursor: pointer;
            font-size: 14px;
            text-align: left;
        }
    </style>
</head>
<body>

    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    
    <!-- ---- НОВЫЙ HTML БЛОК ДЛЯ КНОПОК ---- -->
    <div id="timecodes-container"></div>
    
    <div id="status"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        const statusDiv = document.getElementById('status');
        // ---- ПОЛУЧАЕМ КОНТЕЙНЕР ДЛЯ КНОПОК ----
        const timecodesContainer = document.getElementById('timecodes-container');

        // ---- НОВАЯ ФУНКЦИЯ ДЛЯ КОНВЕРТАЦИИ ВРЕМЕНИ ----
        function timeStrToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 3) { // HH:MM:SS
                seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) { // MM:SS
                seconds = parts[0] * 60 + parts[1];
            }
            return seconds;
        }

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const startTime = parseInt(urlParams.get('start_time') || '0', 10);
            // ---- ПОЛУЧАЕМ ПАРАМЕТР С ТАЙМКОДАМИ ----
            const timecodesParam = urlParams.get('timecodes');

            if (!fileUrl) throw new Error("Аудиофайл не указан.");
            
            titleDiv.innerText = fileName;
            player.src = fileUrl;

            player.addEventListener('canplaythrough', () => {
                player.currentTime = startTime;
                player.play();
                statusDiv.innerText = 'Воспроизведение...';
            }, { once: true });

            player.addEventListener('error', () => {
                const errorMessage = `Ошибка загрузки аудио. Убедитесь, что сервер и туннель запущены.`;
                statusDiv.innerText = errorMessage;
                tg.showAlert(errorMessage);
            });

            // ---- НОВЫЙ БЛОК: СОЗДАНИЕ КНОПОК ----
            if (timecodesParam) {
                try {
                    const timecodes = JSON.parse(timecodesParam);
                    if (Array.isArray(timecodes)) {
                        timecodes.forEach(tc => {
                            const button = document.createElement('button');
                            button.className = 'timecode-button';
                            button.innerText = `${tc.label} (${tc.time})`;
                            
                            // При клике на кнопку перематываем аудио
                            button.onclick = () => {
                                const targetTime = timeStrToSeconds(tc.time);
                                player.currentTime = targetTime;
                                player.play();
                            };
                            
                            timecodesContainer.appendChild(button);
                        });
                    }
                } catch (e) {
                    // Если JSON невалидный, просто ничего не делаем
                    console.error("Ошибка парсинга таймкодов:", e);
                }
            }

        } catch (e) {
            statusDiv.innerText = `Ошибка: ${e.message}`;
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--tg-theme-bg-color, #222); 
            color: var(--tg-theme-text-color, #fff); 
            margin: 0; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh; 
            box-sizing: border-box; 
        }
       #title {  
            font-size: 18px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            text-align: center; 
            /* --- НОВЫЕ СТРОКИ ДЛЯ ПЕРЕНОСА --- */
            overflow-wrap: break-word;
            word-break: break-word;
            /* ---------------------------------- */
        }
        audio { 
            width: 100%; 
            max-width: 400px; 
        }
        #time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #aaa);
            margin-top: 8px;
            margin-bottom: 20px;
        }
        #close-button {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    <div id="time-display">--:-- / --:--</div>
    <div id="timecodes-container"></div>
    
    <!-- Финальная версия кнопки -->
    <button id="close-button">Закрыть</button>
    
    <!-- Весь JavaScript код находится здесь -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- Получаем HTML-элементы ---
        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        const timeDisplay = document.getElementById('time-display');
        const timecodesContainer = document.getElementById('timecodes-container');
        const closeButton = document.getElementById('close-button');
        
        // --- Переменные для хранения состояния ---
        let fileId = null;
        let userId = null;
        let storageKey = null;
        let lastUpdateTime = 0;
        let baseApiUrl = '';

        // --- Функция отправки прогресса на сервер ---
        async function sendProgressUpdate(isFinished = false) {
            if (!fileId || !userId) return;

            const currentTime = Math.floor(player.currentTime);
            const data = {
                file_id: parseInt(fileId, 10),
                user_id: parseInt(userId, 10),
                position: currentTime,
                is_finished: isFinished
            };

            try {
                const response = await fetch(`${baseApiUrl}/api/update_progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const responseData = await response.json();
                console.log('Progress update response:', responseData);
            } catch (error) {
                console.error('Failed to send progress update:', error);
            }
        }

        // --- Функция загрузки и отображения таймкодов ---
        async function loadAndRenderTimecodes() {
            if (!fileId) return;

            try {
                const response = await fetch(`${baseApiUrl}/api/get_timecodes/${fileId}`);
                const timecodes = await response.json();

                timecodesContainer.innerHTML = ''; // Очищаем старые кнопки

                if (Array.isArray(timecodes) && timecodes.length > 0) {
                    timecodes.forEach(tc => {
                        const button = document.createElement('button');
                        button.className = 'timecode-button';
                        button.innerText = `${tc.label} (${tc.time})`;
                        button.onclick = () => {
                            player.currentTime = timeStrToSeconds(tc.time);
                            player.play();
                        };
                        timecodesContainer.appendChild(button);
                    });
                }
            } catch (error) {
                console.error("Failed to load timecodes:", error);
            }
        }

        // --- Вспомогательные функции для времени ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "--:--";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function timeStrToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
            else if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            return seconds;
        }

        try {
            // --- Основной блок ---
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            userId = urlParams.get('user_id');
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const totalDuration = parseInt(urlParams.get('duration') || '0', 10);
            
            if (fileUrl) {
                const urlObject = new URL(fileUrl);
                baseApiUrl = `${urlObject.protocol}//${urlObject.host}`;
            }

            if (!fileUrl || !fileId || !userId) {
                throw new Error("Ключевые параметры (file_id, user_id, file_url) не указаны.");
            }
            
            storageKey = `progress_${fileId}`; 
            const savedProgress = localStorage.getItem(storageKey);
            let lastPosition = savedProgress ? parseInt(savedProgress, 10) : 0;
            
            titleDiv.innerText = fileName;
            player.src = fileUrl;
            timeDisplay.innerText = `${formatTime(lastPosition)} / ${formatTime(totalDuration)}`;

            // Запускаем асинхронную загрузку таймкодов
            loadAndRenderTimecodes();

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
            player.addEventListener('canplaythrough', () => {
                player.currentTime = lastPosition;
                player.play();
            }, { once: true });

            player.addEventListener('timeupdate', () => {
                const currentTime = Math.floor(player.currentTime);
                timeDisplay.innerText = `${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
                localStorage.setItem(storageKey, currentTime);
                
                const now = Date.now();
                if (now - lastUpdateTime > 5000) {
                    sendProgressUpdate();
                    lastUpdateTime = now;
                }
            });

            player.addEventListener('ended', () => {
                localStorage.setItem(storageKey, '0');
                sendProgressUpdate(true);
            });

            player.addEventListener('error', () => {
                tg.showAlert('Ошибка загрузки аудио. Убедитесь, что сервер запущен.');
            });
            
            closeButton.addEventListener('click', () => {
                sendProgressUpdate();
                tg.close();
            });

        } catch (e) {
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>




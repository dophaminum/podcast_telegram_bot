<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <meta name="theme-color" content="#007bff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/nosleep.js/dist/NoSleep.min.js"></script>    
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color, #222); color: var(--tg-theme-text-color, #fff); }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 15px; text-align: center; }
        .footer { flex-shrink: 0; padding: 0 15px 15px 15px; }
        #title { font-size: 18px; font-weight: bold; overflow-wrap: break-word; word-break: break-word; margin-bottom: 20px; }
        audio { width: 100%; max-width: 400px; margin: 0 auto; display: block; }
        #time-display { font-family: 'Courier New', Courier, monospace; font-size: 16px; color: var(--tg-theme-hint-color, #aaa); margin-top: 8px; }
        #timecodes-container { width: 100%; max-width: 400px; margin: 20px auto 0 auto; display: flex; flex-direction: column; gap: 8px; }
        .timecode-button { width: 100%; padding: 12px 15px; border: none; border-radius: 8px; background-color: var(--tg-theme-secondary-bg-color, #333); color: var(--tg-theme-text-color, #fff); cursor: pointer; font-size: 14px; text-align: left; }
        #close-button { width: 100%; max-width: 400px; display: block; margin: 0 auto; padding: 12px; border: none; border-radius: 8px; background-color: var(--tg-theme-button-color, #007bff); color: var(--tg-theme-button-text-color, #fff); cursor: pointer; font-size: 16px; font-weight: bold; }
        .footer {
            display: flex; /* Включаем flex-контейнер */
            gap: 10px; /* Расстояние между кнопками */
            padding: 0 15px 15px 15px;
        }
        /* Общий стиль для кнопок в подвале */
        .footer button {
            flex-grow: 1; /* Кнопки займут равное пространство */
            width: 50%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #close-button {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
        }
        /* Стиль для новой кнопки */
        #open-in-browser-button {
            background-color: var(--tg-theme-secondary-bg-color, #555);
            color: var(--tg-theme-text-color, #fff);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="main-content">
            <div id="title">Загрузка...</div>
            <!-- УЛУЧШЕНИЕ: Добавляем preload="auto" для лучшей буферизации -->
            <audio id="player" controls preload="auto"></audio>
            <div id="time-display">--:-- / --:--</div>
            <div id="timecodes-container"></div>
        </div>
        <div class="footer">
            <!-- НОВАЯ КНОПКА -->
            <button id="open-in-browser-button">Открыть как плеер</button>
            
            <button id="close-button">Закрыть</button>
        </div>
    </div>
    
 <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // --- PWA УЛУЧШЕНИЕ: РЕГИСТРАЦИЯ SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Убедимся, что мы регистрируем sw.js из корня сайта
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker зарегистрирован: ', registration);
                }).catch(registrationError => {
                    console.log('Ошибка регистрации ServiceWorker: ', registrationError);
                });
            });
        }
        // -------------------------------------------------

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const noSleep = new NoSleep();

        // --- Получаем HTML-элементы ---
        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        const timeDisplay = document.getElementById('time-display');
        const timecodesContainer = document.getElementById('timecodes-container');
        const closeButton = document.getElementById('close-button');
        const openInBrowserButton = document.getElementById('open-in-browser-button'); // Находим новую кнопку
        const loaderDiv = document.getElementById('loader');
        
        // --- Переменные состояния ---
        let fileId = null;
        let userId = null;
        let storageKey = null;
        let baseApiUrl = '';
        let lastUpdateTime = 0;

        // --- Вспомогательные функции ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "--:--";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function timeStrToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
            else if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            return seconds;
        }

        async function sendProgressUpdate(isFinished = false) {
            if (!fileId || !userId) return;
            const currentTime = Math.floor(player.currentTime);
            const data = {
                file_id: parseInt(fileId, 10),
                user_id: parseInt(userId, 10),
                position: currentTime,
                is_finished: isFinished
            };
            try {
                await fetch(`${baseApiUrl}/api/update_progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Failed to send progress update:', error);
            }
        }

        async function loadAndRenderTimecodes() {
            if (!fileId) return;
            try {
                const response = await fetch(`${baseApiUrl}/api/get_timecodes/${fileId}`);
                const timecodes = await response.json();
                timecodesContainer.innerHTML = '';
                if (Array.isArray(timecodes) && timecodes.length > 0) {
                    timecodes.forEach(tc => {
                        const button = document.createElement('button');
                        button.className = 'timecode-button';
                        button.innerText = `${tc.label} (${tc.time})`;
                        button.onclick = () => {
                            player.currentTime = timeStrToSeconds(tc.time);
                            player.play();
                        };
                        timecodesContainer.appendChild(button);
                    });
                }
            } catch (error) {
                console.error("Failed to load timecodes:", error);
            }
        }

        function setupMediaSession(fileName, channelName = "Подкаст") {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: fileName,
                    artist: channelName,
                    album: 'Ваш Аудио-Бот',
                    artwork: [
                        { src: 'https://dummyimage.com/512x512/222/fff.png&text=Audio', sizes: '512x512', type: 'image/png' }
                    ]
                });
                navigator.mediaSession.setActionHandler('play', () => player.play());
                navigator.mediaSession.setActionHandler('pause', () => player.pause());
                navigator.mediaSession.setActionHandler('seekbackward', (d) => { player.currentTime = Math.max(0, player.currentTime - (d.seekOffset || 10)); });
                navigator.mediaSession.setActionHandler('seekforward', (d) => { player.currentTime = Math.min(player.duration, player.currentTime + (d.seekOffset || 10)); });
            }
        }

        // --- Основная логика ---
        try {
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            userId = urlParams.get('user_id');
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const totalDuration = parseInt(urlParams.get('duration') || '0', 10);

            if (!fileUrl || !fileId || !userId) {
                throw new Error("Ключевые параметры не указаны.");
            }
            
            const urlObject = new URL(fileUrl);
            baseApiUrl = `${urlObject.protocol}//${urlObject.host}`;

            titleDiv.innerText = fileName;
            storageKey = `progress_${fileId}`;
            const lastPosition = parseInt(localStorage.getItem(storageKey) || '0', 10);
            
            player.src = fileUrl;
            timeDisplay.innerText = `${formatTime(lastPosition)} / ${formatTime(totalDuration)}`;

            loadAndRenderTimecodes();

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
            player.addEventListener('loadedmetadata', () => {
                player.currentTime = lastPosition;
            }, { once: true });

            player.addEventListener('play', () => {
                noSleep.enable();
                setupMediaSession(fileName);
            });

            player.addEventListener('pause', () => {
                noSleep.disable();
            });

            player.addEventListener('timeupdate', () => {
                const currentTime = Math.floor(player.currentTime);
                localStorage.setItem(storageKey, currentTime);
                const now = Date.now();
                if (now - lastUpdateTime > 5000) {
                    sendProgressUpdate();
                    lastUpdateTime = now;
                }
            });

            player.addEventListener('ended', () => {
                noSleep.disable();
                localStorage.setItem(storageKey, '0');
                sendProgressUpdate(true);
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = "none";
                }
            });
            
            closeButton.addEventListener('click', () => {
                sendProgressUpdate();
                tg.close();
            });

            // --- НОВЫЙ ОБРАБОТЧИК ДЛЯ КНОПКИ "ОТКРЫТЬ В БРАУЗЕРЕ" ---
            openInBrowserButton.addEventListener('click', () => {
                // window.location.href - это текущий URL страницы со всеми параметрами
                tg.openLink(window.location.href);
            });

        } catch (e) {
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>






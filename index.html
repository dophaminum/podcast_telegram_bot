<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        /* ... стили остаются без изменений ... */
    </style>
</head>
<body>
    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    <div id="timecodes-container"></div>
    <div id="status"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Раскрываем окно на полную высоту

        const player = document.getElementById('player');
        // ... остальные getElementById без изменений ...

        // --- НОВАЯ ЛОГИКА ---
        let lastUpdateTime = 0;
        let fileId = null;

        // Функция для отправки данных о прогрессе боту
        function sendProgressUpdate(isFinished = false) {
            const currentTime = Math.floor(player.currentTime);
            const dataToSend = {
                file_id: fileId,
                position: currentTime,
                is_finished: isFinished,
            };
            // sendData отправляет строку в виде "невидимого" сообщения от пользователя боту
            tg.sendData(JSON.stringify(dataToSend));
        }

        try {
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            const lastPosition = parseInt(urlParams.get('last_position') || '0', 10);
            
            // Остальные параметры ...
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            const startTime = parseInt(urlParams.get('start_time') || '0', 10);
            
            // ... код для создания кнопок таймкодов без изменений ...

            if (!fileUrl || !fileId) throw new Error("ID файла или URL не указаны.");
            
            document.getElementById('title').innerText = fileName;
            player.src = fileUrl;

            // Устанавливаем стартовую позицию
            player.addEventListener('canplaythrough', () => {
                // Если был передан таймкод (start_time > 0), он в приоритете.
                // Иначе используем сохраненную позицию (last_position).
                player.currentTime = startTime > 0 ? startTime : lastPosition;
                player.play();
                document.getElementById('status').innerText = 'Воспроизведение...';
            }, { once: true });

            // Периодически обновляем прогресс
            player.addEventListener('timeupdate', () => {
                const currentTime = Date.now();
                // Отправляем апдейт не чаще, чем раз в 5 секунд, чтобы не спамить
                if (currentTime - lastUpdateTime > 5000) {
                    sendProgressUpdate();
                    lastUpdateTime = currentTime;
                }
            });

            // Когда аудио доиграло до конца
            player.addEventListener('ended', () => {
                sendProgressUpdate(true);
            });

            // Когда пользователь закрывает WebApp
            tg.onEvent('viewportChanged', (event) => {
                if (!event.isStateStable) {
                     // Пользователь начал свайпать окно вниз, чтобы закрыть
                     sendProgressUpdate();
                }
            });


        } catch (e) {
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Плеер</title>
    <style>
        /* Стили остаются без изменений */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color, #222); color: var(--tg-theme-text-color, #fff); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; height: 100vh; box-sizing: border-box; }
        #title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        audio { width: 100%; max-width: 400px; margin-bottom: 20px; }
        #status { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

    <div id="title">Загрузка аудио...</div>
    <audio id="player" controls></audio>
    <div id="status"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const titleDiv = document.getElementById('title');
        const player = document.getElementById('player');
        const statusDiv = document.getElementById('status');
        
        // Переменные для отслеживания
        let fileId = null;
        // Создаем уникальный ключ для хранения в localStorage
        let storageKey = null;

        try {
            // --- СЧИТЫВАЕМ ДАННЫЕ ИЗ URL ---
            const urlParams = new URLSearchParams(window.location.search);
            fileId = urlParams.get('file_id');
            const fileUrl = urlParams.get('file_url');
            const fileName = urlParams.get('file_name') || 'Аудиозапись';
            // Позиция с тайм-кода, если пользователь нажал на него
            const startTimeFromParam = parseInt(urlParams.get('start_time') || '0', 10);

            if (!fileUrl || !fileId) {
                throw new Error("ID файла или URL не указаны.");
            }
            
            // --- НОВАЯ ЛОГИКА С LOCALSTORAGE ---
            // Ключ будет выглядеть как 'progress_123'
            storageKey = `progress_${fileId}`; 
            
            // Пытаемся загрузить сохраненный прогресс из localStorage
            const savedProgress = localStorage.getItem(storageKey);
            let lastPosition = 0;
            if (savedProgress) {
                lastPosition = parseInt(savedProgress, 10);
            }
            // ------------------------------------

            titleDiv.innerText = fileName;
            player.src = fileUrl;

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ПЛЕЕРА ---
            player.addEventListener('canplaythrough', () => {
                // Если пользователь кликнул на таймкод, он в приоритете. Иначе - начинаем с сохраненной позиции.
                player.currentTime = startTimeFromParam > 0 ? startTimeFromParam : lastPosition;
                player.play();
                statusDiv.innerText = 'Воспроизведение...';
            }, { once: true });

            // Каждые 3 секунды сохраняем текущую позицию в localStorage
            player.addEventListener('timeupdate', () => {
                const currentTime = Math.floor(player.currentTime);
                // Сохраняем позицию. Это очень быстрая операция.
                localStorage.setItem(storageKey, currentTime);
            });

            // Когда аудио закончилось, можно сохранить специальное значение, например -1,
            // или просто сбросить позицию на 0, чтобы в следующий раз начать сначала.
            player.addEventListener('ended', () => {
                localStorage.setItem(storageKey, '0');
            });
            
            player.addEventListener('error', () => {
                const errorMessage = 'Ошибка загрузки аудио. Убедитесь, что сервер запущен.';
                statusDiv.innerText = errorMessage;
                tg.showAlert(errorMessage);
            });

        } catch (e) {
            statusDiv.innerText = `Ошибка: ${e.message}`;
            tg.showAlert(`Критическая ошибка: ${e.message}`);
        }
    </script>
</body>
</html>
